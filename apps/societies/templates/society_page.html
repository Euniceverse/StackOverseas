{% extends "base.html" %}
{% load static %}

{% block title %}
  Society Page - {{ society.name }}
{% endblock %}

{% block content %}
<div class="container my-5" style="max-width: 900px;">
    <h2 class="fw-bold mb-4">{{ society.name }}</h2>
    
    <p>{{ society.description }}</p>
    <p><strong>Type:</strong> {{ society.society_type }}</p>
    <p><strong>Members:</strong> {{ society.members_count }}</p>

<!-- If user is manager/co_manager/editor + approved, show "Manage Society" and "Create Event" -->
{% if user_membership and user_membership.role == "manager" or user_membership and user_membership.role == "co_manager" or user_membership and user_membership.role == "editor" or user.is_superuser %}
    <div class="management-controls d-flex flex-wrap gap-2 mt-3 mb-4">
        <a href="{% url 'manage_society' society.id %}" class="btn btn-warning">
            Manage Members
        </a>

        <a href="{% url 'manage_display' society.id %}" class="btn btn-warning">
            Manage Display
        </a>

        <a href="{% url 'event_create' society.id %}" class="btn btn-primary">
            Create Event
        </a>
    </div>
{% endif %}

    {% if user.is_authenticated %}

        {% if membership %}

            {% if membership.status == 'approved' %}
                <!-- The user is approved and can leave the society -->
                <div class="management-controls d-flex flex-wrap gap-2 mt-3 mb-4">
                    <form action="{% url 'leave_society' society.id %}" method="POST" class="d-inline-block">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            Leave Society
                        </button>
                    </form>
                </div>
                <p>You are a member of this society (Role: {{ membership.get_role_display }}).</p>

            {% elif membership.status == 'pending' %}
                <p class="text-muted">Your membership application is pending.</p>

            {% elif membership.status == 'rejected' %}
                <p class="text-danger">Your application was rejected.</p>
            {% endif %}

        {% else %}
            <!-- The user is logged in but not a member yet -->
            <p>You are not a member of this society.</p>
            <a href="{% url 'join_society' society.id %}"
                class="btn btn-primary"
                id="join-society-link">
                Join Society
            </a>
        {% endif %}

    {% else %}
        <!-- The user is not logged in at all -->
        <p>You are not logged in.
        <a href="{% url 'log_in' %}?next={% url 'society_page' society.id %}">Log in</a>
        to join or leave this society.
        </p>
    {% endif %}

<div id="widgets-container">
  <ul id="sortable-widgets">
    {% for widget in widgets %}
      <li class="widget">
          <h3>{{ widget.get_widget_type_display }}</h3>
            {% if widget.widget_type == "announcements" %}
                {% include 'announcements.html' with widget=widget %}
            {% elif widget.widget_type == "gallery" %}
                <div class="gallery-widget">
                    {% if gallery %}
                        {% include 'partial_gallery.html' with gallery=gallery society=society %}
                    {% else %}
                        <p>No gallery available.</p>
                    {% endif %}
                    <a href="{% url 'panels:society_gallery_list' society_id=society.id %}" class="btn btn-info">View Gallery</a>
                    <a href="{% url 'panels:create_gallery' society_id=society.id %}" class="btn btn-primary">+ Create Gallery</a>
                </div>
            {% elif widget.widget_type == "contacts" %}
                {% include 'contacts.html' with widget=widget %}
            {% elif widget.widget_type == "featured" %}
                {% include 'featured.html' with widget=widget %}
            {% elif widget.widget_type == "leaderboard" %}
                {% include 'leaderboard.html' with widget=widget %}
            {% elif widget.widget_type == "comment" %}
                <div class="comment-widget">
                  {% if recent_comments %}
                    {% include 'partial_comment_list.html' with recent_comments=recent_comments society=society %}
                  {% else %}
                    <p>No comments available.</p>
                  {% endif %}
                  <a href="{% url 'panels:society_comment_feed' society_id=society.id %}" class="btn btn-info">View All Comments</a>
                </div>              
            {% elif widget.widget_type == "polls" %}
                <div class="poll-widget">
                    {% include 'partial_poll_list.html' with recent_polls=recent_polls society=society %}
                  <a href="{% url 'panels:poll_list' society_id=society.id %}" class="btn btn-info">View More</a>
                  <a href="{% url 'panels:create_poll' society_id=society.id %}" class="btn btn-primary">Create New Poll</a>
                </div>
            {% else %}
                <div class="default-widget">
                    {{ widget.custom_html|safe }}
                </div>
            {% endif %}
      </li>
    {% endfor %}
  </ul>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/society_page.js' %}" defer></script>
<script src="{% static 'js/join_society.js' %}" defer></script>
{% endblock %}
